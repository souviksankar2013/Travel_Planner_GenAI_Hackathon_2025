<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Booking Page</title>
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<!-- Include Flatpickr -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>


  <!-- ArcGIS JS API -->
<link rel="stylesheet" href="https://js.arcgis.com/4.30/esri/themes/light/main.css">
<script src="https://js.arcgis.com/4.30/"></script>


  <script type="module">
    // Import Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, signOut, onAuthStateChanged } 
      from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyA3Is_0asWmNhGVN72fSzTwWS7mmdAOKAs",
      authDomain: "trip-planner-genai-hackathon.firebaseapp.com",
      projectId: "trip-planner-genai-hackathon",
      storageBucket: "trip-planner-genai-hackathon.firebasestorage.app",
      messagingSenderId: "1071638693675",
      appId: "1:1071638693675:web:bb6045a93e5c3ac4e5676e",
      measurementId: "G-5C8ZLEJDG7"
    };
  
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    var firstName = null;
  
    // Protect page
    onAuthStateChanged(auth, (user) => {
      if (user) {
        const fullName = user.displayName || "Guest";
        firstName = fullName.split(" ")[0];  // take only the first word
        document.getElementById("username").innerText = `Welcome, ${user.displayName}`;
  
        // Inject bot welcome message
        // const chatWindow = document.getElementById("chatWindow");
        // const botMsg = document.createElement("div");
        // botMsg.className = "text-start mb-2";
        // botMsg.innerHTML = `<span class="chat-message bot-msg">
        //   Hello ${firstName}, I can help you plan your perfect holiday. 
        //   To get started, please tell me where you'd like to go.
        // </span>`;
        // chatWindow.appendChild(botMsg);
      } else {
        window.location.href = "index.html";
      }
    });


    const sessionId = localStorage.getItem("session_id");
    const userId = localStorage.getItem("user_id");
    const first_n = userId.split(" ")[0];

// Automatically notify agent when session is created
  if (sessionId && userId) {
    const chatWindow = document.getElementById("chatWindow");

    fetch("https://hotel-search-genai-hackathon-main-865056791901.asia-south1.run.app/send_message", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        user_id: first_n,
        session_id: sessionId,
        text: "session created"
      }),
    })
      .then((res) => res.json())
      .then((data) => {
        console.log("Agent response (session created):", data);

        const reply =
          data.responses && data.responses.length > 0
            ? data.responses[0]
            : "No welcome response received.";

        const botMsg = document.createElement("div");
        botMsg.className = "text-start mb-2";
        botMsg.innerHTML = `<span class="chat-message bot-msg">${reply}</span>`;
        chatWindow.appendChild(botMsg);

        chatWindow.scrollTop = chatWindow.scrollHeight;
      })
      .catch((err) => {
        console.error("Error sending session created:", err);

        const botMsg = document.createElement("div");
        botMsg.className = "text-start mb-2";
        botMsg.innerHTML = `<span class="chat-message bot-msg">Failed to initialize chat session.</span>`;
        chatWindow.appendChild(botMsg);
      });
  }



  
    // Logout
// Logout
window.logoutUser = function () {
  if (confirm("Do you really want to logout?")) {
    const sessionId = localStorage.getItem("session_id");
    const userId = localStorage.getItem("user_id");

    // First destroy the session on backend
    if (sessionId && userId) {
      fetch("https://hotel-search-genai-hackathon-main-865056791901.asia-south1.run.app/destroy_session", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          user_id: first_n,
          session_id: sessionId
        }),
      })
        .then((res) => res.json())
        .then((data) => {
          console.log("Session destroyed:", data);
        })
        .catch((err) => {
          console.error("Error destroying session:", err);
        })
        .finally(() => {
          // Clear session info from localStorage
          localStorage.removeItem("session_id");
          localStorage.removeItem("user_id");
          localStorage.clear();   // clears all keys for the current domain


          // Now sign out from Firebase
          signOut(auth)
            .then(() => {
              window.location.href = "index.html";
            })
            .catch((error) => {
              alert("Logout failed. Try again.");
              console.error(error);
            });
        });
    } else {
      // If no session exists, just logout
      signOut(auth)
        .then(() => {
          window.location.href = "index.html";
        })
        .catch((error) => {
          alert("Logout failed. Try again.");
          console.error(error);
        });
    }
  }
};

  
    // Sidebar toggle
    window.toggleSidebar = function () {
      document.getElementById("sidebar").classList.toggle("active");
    };
  
    // Chatbot send message

let firstAgentResponded = true; // flag to track if first agent message arrived


window.sendMessage = function () {
  const input = document.getElementById("chatInput");
  const message = input.value.trim();
  if (message === "") return;

  const chatWindow = document.getElementById("chatWindow");

  // Append user message
  const userMsg = document.createElement("div");
  userMsg.className = "text-end mb-2";
  userMsg.innerHTML = `<span class="chat-message user-msg">${message}</span>`;
  chatWindow.appendChild(userMsg);

  chatWindow.scrollTop = chatWindow.scrollHeight;
  input.value = "";

  // Add loading placeholder
  const loadingMsg = document.createElement("div");
  loadingMsg.className = "text-start mb-2";
  loadingMsg.innerHTML = `
    <span class="chat-message bot-msg">
      <span class="loading-spinner"></span> Typing...
    </span>
  `;
  chatWindow.appendChild(loadingMsg);

  const sessionId = localStorage.getItem("session_id");
  const userId = localStorage.getItem("user_id");

  // ---- Detect & Store Variables ----
  let payload = { session_id: sessionId, user_id: userId };

  if (firstAgentResponded) {
    // PLACE detection
    if (!localStorage.getItem("place_name") && isNaN(message)) {
      localStorage.setItem("place_name", message);
      payload.place_name = message;
      console.log("Place name detected:", message);
    }

    // DURATION detection
    if (!localStorage.getItem("duration") && /day/i.test(message)) {
      const duration = message.match(/\d+/)?.[0] || "";
      if (duration) {
        localStorage.setItem("duration", duration);
        payload.duration = duration;
        console.log("Duration detected:", duration);
      }
    }

    // BUDGET detection
    if (!localStorage.getItem("budget") && /(â‚¹|rs|inr|\$|budget)/i.test(message)) {
      const budget = message.match(/\d[\d,]*/)?.[0]?.replace(/,/g, "") || "";
      if (budget) {
        localStorage.setItem("budget", budget);
        payload.budget = budget;
        console.log("Budget detected:", budget);
      }
    }
  }

  // ---- Send flow ----
  const sendMessageToAgent = () => {

    const isHandover = localStorage.getItem("handover_mode") === "true";


    fetch("https://hotel-search-genai-hackathon-main-865056791901.asia-south1.run.app/send_message", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        user_id: userId,
        session_id: sessionId,
        text: message,
        handover: isHandover
      }),
    })
      .then((res) => res.json())
      .then((data) => {
        const reply =
          data.responses && data.responses.length > 0
            ? data.responses[0]
            : "Sorry, I didn't understand that.";



            let renderedReply;

            try {

              // Check if agent is asking for "duration of journey"
                // Your existing reply handling logic
                if (/duration of journey/i.test(reply) || /date of arrival/i.test(reply))  {
                  const inputField = document.getElementById("chatInput");
                  inputField.type = "text"; // keep text type for flatpickr
                  inputField.placeholder = "Select your journey dates";

                  // Initialize or reinitialize the Flatpickr range picker
                  flatpickr(inputField, {
                    mode: "range",
                    dateFormat: "Y-m-d",
                    onClose: function (selectedDates) {
                      if (selectedDates.length === 2) {
                        const startDate = selectedDates[0].toISOString().split("T")[0];
                        const endDate = selectedDates[1].toISOString().split("T")[0];
                        const combined = `${startDate} - ${endDate}`;
                        inputField.value = combined;
                        localStorage.setItem("duration", combined);


                      }
                    },
                  });
                } else {

                  

                  const inputField = document.getElementById("chatInput");

                  // Destroy Flatpickr instance if it still exists
                  if (inputField._flatpickr) {
                    inputField._flatpickr.destroy();
                  }

                  // Reset input field to normal text mode
                  inputField.type = "text";
                  inputField.placeholder = "Type your message...";
                  inputField.value = ""; // Clear content when switching context

                }




              // console.log (reply)
                // Remove ```json ... ``` wrappers if present
                const cleanReply = reply.replace(/```json|```/gi, "").trim();
                // const cleanReply = cleanReply.replace(/can you confirm this itine?ry\??/i, "").trim();

                // console.log(cleanReply)

                // Try parsing as JSON
                const itinerary = JSON.parse(cleanReply);

                // console.log(itinerary)

                // If parsing succeeds â†’ render structured itinerary
                renderedReply = renderItinerary(itinerary);


                // ðŸ”¹ NEW: Ask agent to list all places from itinerary
                fetch("https://hotel-search-genai-hackathon-main-865056791901.asia-south1.run.app/send_message", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    user_id: userId,
                    session_id: sessionId,
                    text: "list out all places present in the itinery. don't put extra texts just list out the places separated by comma"
                  }),
                })
                  .then(res => res.json())
                  .then(data2 => {
                    if (data2.responses && data2.responses.length > 0) {

                      localStorage.setItem("places",data2.responses[0] );

                      payload.places = "["+data2.responses[0]+"]"

                      saveToBackend("save_user_input", payload)

                      

                      // payload.places = c;
                      // Save places string to an event/global variable
                      window.eventPlaces = data2.responses[0];
                      
                      console.log("Places extracted from itinerary:", window.eventPlaces);
                    }
                  })



  .catch(err => console.error("Error extracting places:", err));

              } catch (e) {
                // If not JSON, just show raw text
                // renderedReply = `<span class="chat-message bot-msg">${reply}</span>`;

                if (/\[handover\]/i.test(reply)) {
                  console.log("Handover detected â†’ Switching to Hotel Booking Agent");

                  // Save state in localStorage
                  localStorage.setItem("handover_mode", "true");

                  // Remove [handover] and everything after it
                  const cleaned = reply.split('[handover]')[0].trim();

                  // Show cleaned thank-you message in chat
                  renderedReply = `<span class="chat-message bot-msg">${cleaned}</span>`;

                  // ðŸ”¹ Immediately send internal message to agent
                  fetch("https://hotel-search-genai-hackathon-main-865056791901.asia-south1.run.app/send_message", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                      user_id: userId,
                      session_id: sessionId,
                      text: "switch to hotel booking agent.",
                      handover: true
                    }),
                  })
                    .then(res => res.json())
                    .then(data2 => {
                      const bookingReply =
                        data2.responses && data2.responses.length > 0
                          ? data2.responses[0]
                          : "Hotel booking agent not available right now.";

                      // Append hotel booking agent reply
                      const bookingMsg = document.createElement("div");
                      bookingMsg.className = "text-start mb-2";
                      bookingMsg.innerHTML = `<span class="chat-message bot-msg">${bookingReply}</span>`;
                      chatWindow.appendChild(bookingMsg);
                      chatWindow.scrollTop = chatWindow.scrollHeight;
                    })
                    .catch(err => {
                      console.error("Error switching to hotel booking agent:", err);
                    });
                }




                // If not JSON, check if it's the "Very nice!" options
               else if (/Very nice!/i.test(reply) && /Fast-Paced/i.test(reply)) {
                    renderedReply = renderOptions(reply);
                  } 

               else if (/\|.+\|/s.test(reply) && reply.includes("---")) {


                 
                (async () => {
                    const geoData = await fetchgeocode();    // geoData is returned JSON

                    // inspect
                    console.log("geoData after fetchgeocode:", geoData);
                    console.log("window.geocodedPlaces:", window.geocodedPlaces);

                    openmap();

                    console.log (reply)

                    // Now render table
                    const htmlTable = await markdownTableToHTML(reply);  // reply is your markdown string
                    // console.log("htmlTable:", reply);          // should be <div>...</div>

                    // renderedReply = `<div class="chat-message bot-msg">${reply}</div>`;

                    // renderedReply = htmlTable;
                        // Assign result back
                    renderedReply = htmlTable;

                // Update chat window
                loadingMsg.innerHTML = renderedReply;
                chatWindow.scrollTop = chatWindow.scrollHeight;

                  })();

                  return;



                }
                  
                  
                  
                  
                  
                  else {
                    // Fallback to plain text
                    renderedReply = `<span class="chat-message bot-msg">${reply}</span>`;
                   
                  }
              }


              loadingMsg.innerHTML = renderedReply;
              chatWindow.scrollTop = chatWindow.scrollHeight;


        // loadingMsg.innerHTML = `<span class="chat-message bot-msg">${reply}</span>`;
        // chatWindow.scrollTop = chatWindow.scrollHeight;

        if (!firstAgentResponded) {
          firstAgentResponded = true;
        }
      })
      .catch((err) => {
        console.error("Error sending message:", err);
        loadingMsg.innerHTML = `<span class="chat-message bot-msg">Error talking to agent.</span>`;
      });
  };

  // ---- Save first, then send ----
  if (payload.place_name || payload.duration || payload.budget) {
    saveToBackend("save_user_input", payload).then(sendMessageToAgent);
  } else {
    sendMessageToAgent();
  }

  // ---- Helper: Save to backend ----
  function saveToBackend(endpoint, payload) {
    return fetch(
      `https://hotel-search-genai-hackathon-main-865056791901.asia-south1.run.app/${endpoint}`,
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      }
    )
      .then((res) => res.json())
      .then((data) => {
        console.log(`${endpoint} saved in session:`, data);
        return data;
      })
      .catch((err) => {
        console.error(`Error saving ${endpoint}:`, err);
      });
  }
};

async function fetchgeocode() {
  const placesString = localStorage.getItem("places");
  if (!placesString) {
    console.warn("No places in localStorage");
    return null;
  }

  try {
    const response = await fetch(
      "https://hotel-search-genai-hackathon-hotelmcp-865056791901.asia-south1.run.app/geocode",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ place_name: placesString }),
      }
    );

    const data = await response.json();
    console.log("Geocode API returned:", data);

    // store globally
    window.geocodedPlaces = data;
    return data;                // <-- return here!
  } catch (err) {
    console.error("Error geocoding places:", err);
    return null;
  }
}



function renderItinerary(itinerary) {
  let html = `
    <div class="chat-message bot-msg itinerary-card">
      <h4>Trip to ${itinerary.destination}</h4>
      <p><b>People:</b> ${itinerary.num_people}</p>
      <p><b>Pace:</b> ${itinerary.pace} (${itinerary.duration_days} days)</p>
      <p><b>Budget:</b> ${itinerary.budget}</p>
      <hr>
  `;

  itinerary.itinerary.forEach((dayPlan) => {
    html += `
      <div class="day-block">
        <h5>Day ${dayPlan.day}</h5>
        <p><b>Morning:</b> ${dayPlan.morning.activity} (â‚¹${dayPlan.morning.budget})</p>
        <p><b>Lunch:</b> ${dayPlan.lunch.activity} (â‚¹${dayPlan.lunch.budget})</p>
        <p><b>Afternoon:</b> ${dayPlan.afternoon.activity} (â‚¹${dayPlan.afternoon.budget})</p>
      </div>
      <hr>
    `;
  });

  html += `
      <p><b>Total Estimated Budget:</b> ${itinerary.total_budget}</p>
      <p><i>${itinerary.notes}</i></p>

      <p>Can you confirm this itinerary?</p>
     
    </div>
  `;

  // html += `
  //                       <div class="mt-2 chat-message bot-msg">Can you confirm this itinery?</div>
  //                       <button class="btn btn-primary btn-sm" onclick="sendMessage('Yes')">Confirm</button>
  //                       <button class="btn btn-secondary btn-sm" onclick="sendMessage('No')">Change</button>
  //                     `;
  return html;
}



// async function markdownTableToHTML(markdown) {
//   const lines = markdown.trim().split("\n").filter(l => l.trim() !== "");
//   if (lines.length < 2) return markdown;

//   // ---- Detect intro text ----
//   let introText = "";
//   let tableStartIndex = 0;
//   if (!lines[0].includes("|") || !lines[1].includes("---")) {
//     introText = lines[0];
//     tableStartIndex = 1;
//   }

//   // ---- Extract headers ----
//   const headersAll = lines[tableStartIndex]
//     .split("|")
//     .map(h => h.trim())
//     .filter(Boolean);

//   const latIndex = headersAll.findIndex(h => /lat/i.test(h));
//   const lonIndex = headersAll.findIndex(h => /lon/i.test(h));
//   const touristIndex = headersAll.findIndex(h => /tourist/i.test(h));
//   const totalDistIndex = headersAll.findIndex(h => /total\s*distance/i.test(h));
//   const checkinIndex = headersAll.findIndex(h => /check.?in/i.test(h));
//   const checkoutIndex = headersAll.findIndex(h => /check.?out/i.test(h));
//   const facilitiesIndex = headersAll.findIndex(h => /facilit/i.test(h));

//   // ---- Remove fields for modal only ----
//   const headers = headersAll.filter(
//     (_, idx) =>
//       ![
//         latIndex,
//         lonIndex,
//         touristIndex,
//         totalDistIndex,
//         checkinIndex,
//         checkoutIndex,
//         facilitiesIndex,
//       ].includes(idx)
//   );

//   // Add custom action columns
//   headers.push("Distance Info");
//   headers.push("Book Hotel");

//   // ---- Extract rows ----
//   const allRows = lines.slice(tableStartIndex + 2).map(row =>
//     row.split("|").map(cell => cell.trim()).filter(Boolean)
//   );

//   const latLongArray = [];
//   const touristInfoArray = [];
//   const totalDistanceArray = [];
//   const modalDetails = [];

//   const rows = allRows.map(r => {
//     const lat = latIndex !== -1 ? parseFloat(r[latIndex]) : null;
//     const lon = lonIndex !== -1 ? parseFloat(r[lonIndex]) : null;
//     latLongArray.push([lat, lon]);
//     touristInfoArray.push(touristIndex !== -1 ? r[touristIndex] : "N/A");
//     totalDistanceArray.push(totalDistIndex !== -1 ? r[totalDistIndex] : "N/A");

//     modalDetails.push({
//       checkin: checkinIndex !== -1 ? r[checkinIndex] : "N/A",
//       checkout: checkoutIndex !== -1 ? r[checkoutIndex] : "N/A",
//       facilities: facilitiesIndex !== -1 ? r[facilitiesIndex] : "N/A",
//     });

//     return r.filter(
//       (_, idx) =>
//         ![
//           latIndex,
//           lonIndex,
//           touristIndex,
//           totalDistIndex,
//           checkinIndex,
//           checkoutIndex,
//           facilitiesIndex,
//         ].includes(idx)
//     );
//   });

//   // ---- Build HTML ----
//   let html = "";
//   if (introText) {
//     html += `<div class="chat-message bot-msg">${introText}</div>`;
//   }

//   html += `<div class="chat-message bot-msg">
//   <table class='table table-bordered table-striped hotel-table'>
//   <thead><tr>`;
//   headers.forEach(h => (html += `<th>${h}</th>`));
//   html += "</tr></thead><tbody>";

//   rows.forEach((r, rowIndex) => {
//     html += `<tr data-row-index="${rowIndex}">`;
//     r.forEach(c => (html += `<td>${c}</td>`));
//     html += `<td><button class="btn btn-sm btn-primary view-distance" data-index="${rowIndex}">View</button></td>`;
//     html += `<td><button class="btn btn-sm btn-success book-hotel" data-index="${rowIndex}">Book Hotel</button></td>`;
//     html += "</tr>";
//   });

//   html += "</tbody></table></div>";

//   window.hotelLatLongs = latLongArray;
//   window.hotelTouristPlaces = touristInfoArray;
//   window.hotelTotalDistances = totalDistanceArray;
//   window.hotelModalDetails = modalDetails;

//   // ---- Modal Structure ----
//   if (!document.getElementById("touristModal")) {
//     const modalHTML = `
//       <div class="modal fade" id="touristModal" tabindex="-1" role="dialog">
//         <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
//           <div class="modal-content">
//             <div class="modal-header bg-primary text-white">
//               <h5 class="modal-title">Hotel Details</h5>
//               <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
//             </div>
//             <div class="modal-body">
//               <div id="touristDetails"></div>
//             </div>
//             <div class="modal-footer">
//               <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
//             </div>
//           </div>
//         </div>
//       </div>`;
//     document.body.insertAdjacentHTML("beforeend", modalHTML);
//   }

//   // ---- Attach Click Handlers ----
//   setTimeout(() => {
//     // View Distance
//     document.querySelectorAll(".view-distance").forEach(btn => {
//       btn.addEventListener("click", () => {
//         const index = parseInt(btn.getAttribute("data-index"));
//         const modalInfo = window.hotelModalDetails[index];
//         const places = window.hotelTouristPlaces[index] || "N/A";
//         const totalDist = window.hotelTotalDistances[index] || "N/A";

//         document.getElementById("touristDetails").innerHTML = `
//           <div><strong>Tourist Places:</strong><br>${places}</div><hr>
//           <div><strong>Total Distance:</strong> ${totalDist}</div><hr>
//           <div><strong>Check-in:</strong> ${modalInfo.checkin}</div>
//           <div><strong>Check-out:</strong> ${modalInfo.checkout}</div>
//           <div><strong>Facilities:</strong> ${modalInfo.facilities}</div>
//         `;

//         const modal = new bootstrap.Modal(document.getElementById("touristModal"));
//         modal.show();
//       });
//     });

//     // Book Hotel

//     // Book Hotel (fixed)
// document.querySelectorAll(".book-hotel").forEach(btn => {
//   btn.addEventListener("click", (ev) => {
//     ev.stopPropagation(); // prevent row-click zoom when clicking the button

//     const index = parseInt(btn.getAttribute("data-index"), 10);
//     const tr = btn.closest("tr");
//     if (!tr) return;

//     // Convert NodeList -> Array
//     const cellsArr = Array.from(tr.querySelectorAll("td"));

//     // Build header->index map (read current table headers)
//     const headerTexts = Array.from(document.querySelectorAll("table thead th")).map(th =>
//       th.textContent.trim()
//     );

//     // Find indexes for columns (case-insensitive)
//     const nameCol = headerTexts.findIndex(h => /name/i.test(h));
//     const ratingCol = headerTexts.findIndex(h => /rating/i.test(h));
//     const roomsCol = headerTexts.findIndex(h => /room/i.test(h));
//     const priceCol = headerTexts.findIndex(h => /\bprice\b/i.test(h) || /prices?/i.test(h));

//     // Safely read cell text (fall back to "N/A")
//     const safeText = (arr, idx) => {
//       if (idx === -1) return "N/A";
//       const el = arr[idx];
//       return el ? el.textContent.trim() : "N/A";
//     };

//     const hotelName = safeText(cellsArr, nameCol);
//     const rating = safeText(cellsArr, ratingCol);
//     const rooms = safeText(cellsArr, roomsCol);
//     const price = safeText(cellsArr, priceCol);
//     const duration = localStorage.getItem("duration");

//     const bookingString = `${hotelName}_${rating}_${rooms}_${price}_${duration}`;
//     alert(bookingString);
//   });
// });



//     // Row click zoom
//     const headers = Array.from(document.querySelectorAll("table thead th")).map(th =>
//       th.textContent.trim()
//     );

//     document.querySelectorAll("tr[data-row-index]").forEach(tr => {
//       tr.addEventListener("click", () => {
//         const idx = parseInt(tr.getAttribute("data-row-index"));
//         const coords = window.hotelLatLongs[idx];

//         if (window.mapView && coords) {
//           window.mapView.goTo({ center: [coords[1], coords[0]], zoom: 15 }).catch(console.error);
//         }
//       });
//     });
//   }, 200);

//   return html;
// }



async function markdownTableToHTML(markdown) {
  const lines = markdown.trim().split("\n").filter(l => l.trim() !== "");
  if (lines.length < 2) return markdown;

  // ---- Detect intro text ----
  let introText = "";
  let tableStartIndex = 0;
  if (!lines[0].includes("|") || !lines[1].includes("---")) {
    introText = lines[0];
    tableStartIndex = 1;
  }

  // ---- Extract headers ----
  const headersAll = lines[tableStartIndex]
    .split("|")
    .map(h => h.trim())
    .filter(Boolean);

  const latIndex = headersAll.findIndex(h => /lat/i.test(h));
  const lonIndex = headersAll.findIndex(h => /lon/i.test(h));
  const touristIndex = headersAll.findIndex(h => /tourist/i.test(h));
  const totalDistIndex = headersAll.findIndex(h => /total\s*distance/i.test(h));
  const checkinIndex = headersAll.findIndex(h => /check.?in/i.test(h));
  const checkoutIndex = headersAll.findIndex(h => /check.?out/i.test(h));
  const facilitiesIndex = headersAll.findIndex(h => /facilit/i.test(h));
  const addressIndex = headersAll.findIndex(h => /address/i.test(h)); // ðŸ†• Added Address detection

  // ---- Remove fields for modal-only ----
  const headers = headersAll.filter(
    (_, idx) =>
      ![
        latIndex,
        lonIndex,
        touristIndex,
        totalDistIndex,
        checkinIndex,
        checkoutIndex,
        facilitiesIndex,
      ].includes(idx)
  );

  // Add custom action columns
  headers.push("Distance Info");
  headers.push("Book Hotel");

  // ---- Extract rows ----
  const allRows = lines.slice(tableStartIndex + 2).map(row =>
    row.split("|").map(cell => cell.trim()).filter(Boolean)
  );

  const latLongArray = [];
  const touristInfoArray = [];
  const totalDistanceArray = [];
  const modalDetails = [];

  const rows = allRows.map(r => {
    const lat = latIndex !== -1 ? parseFloat(r[latIndex]) : null;
    const lon = lonIndex !== -1 ? parseFloat(r[lonIndex]) : null;
    latLongArray.push([lat, lon]);
    touristInfoArray.push(touristIndex !== -1 ? r[touristIndex] : "N/A");
    totalDistanceArray.push(totalDistIndex !== -1 ? r[totalDistIndex] : "N/A");

    modalDetails.push({
      address: addressIndex !== -1 ? r[addressIndex] : "N/A", // ðŸ†• Save Address
      checkin: checkinIndex !== -1 ? r[checkinIndex] : "N/A",
      checkout: checkoutIndex !== -1 ? r[checkoutIndex] : "N/A",
      facilities: facilitiesIndex !== -1 ? r[facilitiesIndex] : "N/A",
    });

    return r.filter(
      (_, idx) =>
        ![
          latIndex,
          lonIndex,
          touristIndex,
          totalDistIndex,
          checkinIndex,
          checkoutIndex,
          facilitiesIndex,
        ].includes(idx)
    );
  });

  // ---- Build HTML ----
  let html = "";
  if (introText) {
    html += `<div class="chat-message bot-msg">${introText}</div>`;
  }

  html += `<div class="chat-message bot-msg">
  <table class='table table-bordered table-striped hotel-table'>
  <thead><tr>`;
  headers.forEach(h => (html += `<th>${h}</th>`));
  html += "</tr></thead><tbody>";

  rows.forEach((r, rowIndex) => {
    html += `<tr data-row-index="${rowIndex}">`;
    r.forEach(c => (html += `<td>${c}</td>`));
    html += `<td><button class="btn btn-sm btn-primary view-distance" data-index="${rowIndex}">View</button></td>`;
    html += `<td><button class="btn btn-sm btn-success book-hotel" data-index="${rowIndex}">Book Hotel</button></td>`;
    html += "</tr>";
  });

  html += "</tbody></table></div>";

  window.hotelLatLongs = latLongArray;
  window.hotelTouristPlaces = touristInfoArray;
  window.hotelTotalDistances = totalDistanceArray;
  window.hotelModalDetails = modalDetails;

  // ---- Modal Structure ----
  if (!document.getElementById("touristModal")) {
    const modalHTML = `
      <div class="modal fade" id="touristModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
          <div class="modal-content">
            <div class="modal-header bg-primary text-white">
              <h5 class="modal-title">Hotel Details</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div id="touristDetails"></div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>`;
    document.body.insertAdjacentHTML("beforeend", modalHTML);
  }

  // ---- Attach Click Handlers ----
  setTimeout(() => {
    // View Distance Button
    document.querySelectorAll(".view-distance").forEach(btn => {
      btn.addEventListener("click", () => {
        const index = parseInt(btn.getAttribute("data-index"));
        const modalInfo = window.hotelModalDetails[index];
        const places = window.hotelTouristPlaces[index] || "N/A";
        const totalDist = window.hotelTotalDistances[index] || "N/A";

        document.getElementById("touristDetails").innerHTML = `
          <div><strong>Address:</strong> ${modalInfo.address}</div><hr>
          <div><strong>Tourist Places:</strong><br>${places}</div><hr>
          <div><strong>Total Distance:</strong> ${totalDist}</div><hr>
          <div><strong>Check-in:</strong> ${modalInfo.checkin}</div>
          <div><strong>Check-out:</strong> ${modalInfo.checkout}</div>
          <div><strong>Facilities:</strong> ${modalInfo.facilities}</div>
        `;

        const modal = new bootstrap.Modal(document.getElementById("touristModal"));
        modal.show();
      });
    });

    // Book Hotel
    // ---- Book Hotel Button ----
document.querySelectorAll(".book-hotel").forEach(btn => {
  btn.addEventListener("click", ev => {
    ev.stopPropagation();

    const tr = btn.closest("tr");
    if (!tr) return;

    const rowIndex = parseInt(btn.getAttribute("data-index"), 10);
    const cellsArr = Array.from(tr.querySelectorAll("td"));
    const headerTexts = Array.from(document.querySelectorAll("table thead th")).map(th =>
      th.textContent.trim()
    );

    // Ignore last two action columns ("Distance Info" and "Book Hotel")
    const effectiveHeaders = headerTexts.slice(0, headerTexts.length - 2);

    // Find relevant columns by header name
    const nameCol = effectiveHeaders.findIndex(h => /name/i.test(h));
    const ratingCol = effectiveHeaders.findIndex(h => /rating/i.test(h));
    const roomsCol = effectiveHeaders.findIndex(h => /room/i.test(h));
    const priceCol = effectiveHeaders.findIndex(h => /\bprice\b/i.test(h) || /prices?/i.test(h));

    // Safe getter
    const safeText = (arr, idx) => {
      if (idx === -1 || idx >= arr.length) return "N/A";
      const el = arr[idx];
      return el ? el.textContent.trim() : "N/A";
    };

    const hotelName = safeText(cellsArr, nameCol);
    const rating = safeText(cellsArr, ratingCol);
    const rooms = safeText(cellsArr, roomsCol);
    const price = safeText(cellsArr, priceCol);
    const duration = localStorage.getItem("duration");

    const bookingString = `${hotelName}_${rating}_${rooms}_${price}_${duration}`;
    alert(bookingString);
  });
});


    // Row click zoom
    document.querySelectorAll("tr[data-row-index]").forEach(tr => {
      tr.addEventListener("click", () => {
        const idx = parseInt(tr.getAttribute("data-row-index"));
        const coords = window.hotelLatLongs[idx];
        if (window.mapView && coords) {
          window.mapView.goTo({ center: [coords[1], coords[0]], zoom: 15 }).catch(console.error);
        }
      });
    });
  }, 200);

  return html;
}












function renderOptions(text) {
  // Extract destination
  const destinationMatch = text.match(/cover\s+([A-Za-z\s]+)/i);
  const destination = destinationMatch ? destinationMatch[1].trim() : "";

  // Extract lines after "Very nice!"
  const options = text
    .split(/\n|(?=\d\.)/) // split by newline or numbered list
    .map((line) => line.trim())
    .filter((line) => /^\d?\s?.*:\s?.*days/i.test(line));

  const optionsHtml = options
    .map(
      (opt) =>
        `<li class="border rounded p-2 my-1 cursor-pointer hover:bg-gray-100">${opt}</li>`
    )
    .join("");

  return `
    <div class="chat-message bot-msg">
      <p><strong>Very nice!</strong> Tell me how you want to cover <strong>${destination}</strong>:</p>
      <ol class="list-none pl-0">${optionsHtml}</ol>
      <p class="mt-2">Please enter the option number.</p>
    </div>
  `;
}











  
    // Enter key handler
    window.addEventListener("keydown", function (e) {
      if (e.key === "Enter" && document.getElementById("chatInput") === document.activeElement) {
        sendMessage();
      }
    });



    // Show booking history panel and load map
    window.openmap = function () {



      
  const panel = document.getElementById("bookingHistoryPanel");
  const chat = document.getElementById("chatContainer");

  panel.classList.toggle("active");
  chat.classList.toggle("shrink");

  if (!window.mapViewInitialized) {
    require([
  "esri/Map",
  "esri/views/MapView",
  "esri/Graphic",
  "esri/layers/GraphicsLayer"
], function (Map, MapView, Graphic, GraphicsLayer) {
  const map = new Map({
    basemap: "streets-vector"
  });

  const view = new MapView({
    container: "mapView",
    map: map,
    center: [77.2090, 28.6139], // Delhi [lon, lat]
    zoom: 11
  });

  // Add a GraphicsLayer for markers
  const graphicsLayer = new GraphicsLayer();
  map.add(graphicsLayer);

  // Wait until the view is fully ready before plotting
  view.when(() => {
  const allGraphics = [];

  // ---- Plot hotel lat/lngs ----
  if (window.hotelLatLongs && window.hotelLatLongs.length > 0) {
    window.hotelLatLongs.forEach(coords => {
      const [lat, lon] = coords;
      const point = {
        type: "point",
        longitude: lon,
        latitude: lat
      };

      const markerSymbol = {
        type: "picture-marker",
        url: "https://cdn-icons-png.flaticon.com/512/684/684908.png", // balloon icon
        width: "32px",
        height: "32px"
      };

      const pointGraphic = new Graphic({
        geometry: point,
        symbol: markerSymbol
      });

      graphicsLayer.add(pointGraphic);
      allGraphics.push(pointGraphic);
    });
  } else {
    console.warn("No hotelLatLongs array found or empty.");
  }

  // ---- Plot geocoded places with popup ----
  if (window.geocodedPlaces) {
    (window.geocodedPlaces.geocoded_places || []).forEach(place => {
      const [name, lat, lon] = place;
      const point = { type: "point", longitude: lon, latitude: lat };

      const markerSymbol = {
        type: "picture-marker",
        url: "https://cdn-icons-png.flaticon.com/512/190/190411.png", // green balloon icon
        width: "32px",
        height: "32px"
      };

      const graphic = new Graphic({
        geometry: point,
        symbol: markerSymbol,
        attributes: { name },
        popupTemplate: {
          title: "{name}",   // show the name dynamically
          content: "Point of Interest"
        }
      });

      graphicsLayer.add(graphic);
      allGraphics.push(graphic);
    });
  }

  // ---- Zoom to extent of all graphics ----
  if (allGraphics.length > 0) {
    view.goTo(allGraphics, { padding: 50 }).catch(err => console.error("goTo error:", err));
  }
});


  window.mapView = view; 
  window.mapViewInitialized = true;
});


  }
};

window.openBookingHistory= function () {
    window.location.href = "history.html"; // make sure file name matches
  }

window.createSession = function () {


  const userId = localStorage.getItem("user_id");


  fetch("https://hotel-search-genai-hackathon-main-865056791901.asia-south1.run.app/destroy_session", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          user_id: first_n,
          session_id: sessionId
        }),
      })
        .then((res) => res.json())
        .then((data) => {
          console.log("Session destroyed:", data);


        })
        .catch((err) => {
          console.error("Error destroying session:", err);
        })
        .finally(() => {
          localStorage.removeItem("place_name");
          localStorage.removeItem("places");
          // Clear session info from localStorage
          // localStorage.removeItem("session_id");
          // localStorage.removeItem("user_id");
          // localStorage.clear();   // clears all keys for the current domain


          fetch("https://hotel-search-genai-hackathon-main-865056791901.asia-south1.run.app/create_session", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ user_id: userId })
  })
    .then(res => res.json())
    .then(data => {
      if (data.session_id) {
        localStorage.setItem("session_id", data.session_id);
        localStorage.setItem("user_id", data.user_id);

        console.log("New session created:", data.session_id);
        // alert("New session started!");
        // optional: clear old chat UI
        document.getElementById("chatWindow").innerHTML = "";
        const sessionId = localStorage.getItem("session_id");

//first message sesssion created

        if (sessionId && userId) {
    const chatWindow = document.getElementById("chatWindow");

    fetch("https://hotel-search-genai-hackathon-main-865056791901.asia-south1.run.app/send_message", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        user_id: first_n,
        session_id: sessionId,
        text: "session created"
      }),
    })
      .then((res) => res.json())
      .then((data) => {
        console.log("Agent response (session created):", data);

        const reply =
          data.responses && data.responses.length > 0
            ? data.responses[0]
            : "No welcome response received.";

        const botMsg = document.createElement("div");
        botMsg.className = "text-start mb-2";
        botMsg.innerHTML = `<span class="chat-message bot-msg">${reply}</span>`;
        chatWindow.appendChild(botMsg);

        chatWindow.scrollTop = chatWindow.scrollHeight;
      })
      .catch((err) => {
        console.error("Error sending session created:", err);

        const botMsg = document.createElement("div");
        botMsg.className = "text-start mb-2";
        botMsg.innerHTML = `<span class="chat-message bot-msg">Failed to initialize chat session.</span>`;
        chatWindow.appendChild(botMsg);
      });
  }







      } else {
        alert("Failed to create session");
      }
    })
    .catch(err => console.error("Error creating session:", err));




        });






  


};





  </script>
  

  <style>
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: #f0f4f8;
      color: #333;
      height: 100%;
      width: 100%;
      overflow: hidden;
    }

    header {
      background:linear-gradient(135deg, #3C3BEE 0%, #00C6FF 100%);
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1100;
    }

    header h1 {
      margin: 0;
      font-size: 22px;
      font-weight: 600;
    }

    #username {
      font-size: 16px;
    }

    /* Sidebar styles */
    #sidebar {
      position: fixed;
      left: 0; /* open by default */
      top: 0;
      width: 250px;
      height: 100%;
      background: linear-gradient(135deg, #3C3BEE 0%, #00C6FF 100%);;
      color: white;
      padding-top: 60px;
      z-index: 1000;
    }
    #sidebar ul {
      list-style: none;
      padding: 0;
    }
    #sidebar ul li {
      padding: 15px 20px;
      cursor: pointer;
      transition: background 0.2s;
    }
    #sidebar ul li:hover {
      background: #3b5998;
    }

    /* Chatbot full screen */
    .chat-container {
      position: fixed;
      top: 60px; /* below header */
      left: 250px; /* after sidebar */
      right: 0;
      bottom: 0;
      background: #fff;
      display: flex;
      flex-direction: column;
    }
    #chatWindow {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      background: #f9f9f9;
    }
    .chat-input-area {
      display: flex;
      border-top: 1px solid #ccc;
    }
    .chat-input-area input {
      flex: 1;
      border: none;
      padding: 10px;
    }
    .chat-input-area button {
      border: none;
      padding: 10px 20px;
      background: #1e3a8a;
      color: white;
    }

    /* Chat message styles */
/* Chat message styles */
    .chat-message {
      display: inline-block;
      font-size: 16px;   /* slightly smaller than 18px */
      padding: 10px 14px;
      border-radius: 10px;
      line-height: 1.4;
      max-width: 70%;
      word-wrap: break-word;
    }

    /* User message */
    .user-msg {
      background: #3C3BEE;
      color: white;
      text-align: right;
      font-weight: 500;
    }

    /* Bot message */
    .bot-msg {
      background: #2f3a83;
      color: white;
      text-align: left;
      font-weight: 500;
    }

    .loading-spinner {
  display: inline-block;
  width: 12px;
  height: 12px;
  border: 2px solid #ccc;
  border-top: 2px solid #333;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-right: 6px;
  vertical-align: middle;
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}


#bookingHistoryPanel {
  position: fixed;
  top: 60px; /* below header */
  right: -500px; /* hidden off screen */
  width: 500px;
  height: calc(100% - 60px);
  background: #fff;
  box-shadow: -2px 0 6px rgba(0,0,0,0.2);
  z-index: 1200;
  transition: right 0.3s ease;
  display: flex;
  flex-direction: column;
}

#bookingHistoryPanel.active {
  right: 0; /* slide in */
}

#mapView {
  flex: 1;
}

/* default full width */
#chatContainer {
  position: fixed;
  top: 60px;
  left: 250px;
  right: 0;
  bottom: 0;
  background: #fff;
  display: flex;
  flex-direction: column;
  transition: width 0.3s ease, right 0.3s ease;
}

/* when panel active â€“ reduce width by panel width (400px) */
#chatContainer.shrink {
  right: 500px;
}





  </style>
</head>
<body>
  <header>
    <span class="menu-icon" onclick="toggleSidebar()">â˜°</span>
    <h1>Personalised Trip Planner</h1>
    <span id="username"></span>
  </header>

  <!-- Sidebar -->
  <div id="sidebar">
    <ul>
      <li onclick="createSession()">New Booking</li>
      <li onclick="openBookingHistory()">Booking History</li>
      <li onclick="logoutUser()">Logout</li>
    </ul>
  </div>

  <!-- Chatbot Full Screen -->
  <div id="chatContainer" class="chat-container">
    <div id="chatWindow"></div>
    <div class="chat-input-area">
      <input type="text" id="chatInput" placeholder="Type a message..." />
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

  <!-- Booking History Sliding Panel -->
<div id="bookingHistoryPanel">
  <div id="mapView"></div>
</div>



</body>
</html>
